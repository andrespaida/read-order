name: Deploy read-order to EC2 (qa)

on:
  push:
    branches:
      - qa

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Copy files to EC2 via SCP
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        source: "."
        target: "~/read-order"

    - name: Connect to EC2 and build/run Docker container
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        script: |
          # Install Docker if not installed
          if ! command -v docker &> /dev/null
          then
            echo "ğŸ”§ Installing Docker..."
            sudo apt-get update
            sudo apt-get install -y docker.io
            sudo systemctl start docker
            sudo systemctl enable docker
          fi

          # Navigate to project directory
          cd ~/read-order

          # Build Docker image locally
          echo "ğŸ³ Building Docker image locally..."
          sudo docker build -t read-order:latest .

          # Stop and remove existing container if running
          echo "ğŸ§¹ Stopping and removing existing container if any..."
          sudo docker stop read-order || true
          sudo docker rm read-order || true

          # Run the new container
          echo "ğŸš€ Running the new container..."
          sudo docker run -d \
            --name read-order \
            --restart=always \
            -p 4001:4001 \
            read-order:latest